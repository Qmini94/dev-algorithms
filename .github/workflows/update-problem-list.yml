name: Update Problem List

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'src/main/java/problems/programmers/**'
      - 'src/test/java/problems/programmers/**'
      - 'docs/problems/programmers/**'

jobs:
  update-list:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Generate problem list
        run: |
          python3 << 'EOF'
          import os
          from pathlib import Path
          from collections import defaultdict
          
          # ê²½ë¡œ ì„¤ì •
          base_path = Path('.')
          src_main = base_path / 'src' / 'main' / 'java' / 'problems' / 'programmers'
          src_test = base_path / 'src' / 'test' / 'java' / 'problems' / 'programmers'
          docs_path = base_path / 'docs' / 'problems' / 'programmers'
          output_file = base_path / 'problems' / 'programmers.md'
          
          # ë ˆë²¨ë³„ë¡œ íŒŒì¼ ìˆ˜ì§‘
          problems = defaultdict(lambda: {'solution': None, 'test': None, 'doc': None})
          
          # src/main/java íŒŒì¼ ìˆ˜ì§‘
          if src_main.exists():
              for level_dir in sorted(src_main.iterdir()):
                  if level_dir.is_dir():
                      level = level_dir.name.upper()
                      for java_file in sorted(level_dir.glob('*.java')):
                          problem_name = java_file.stem
                          key = f"{level}:{problem_name}"
                          problems[key]['solution'] = str(java_file.relative_to(base_path))
                          problems[key]['level'] = level
                          problems[key]['name'] = problem_name
          
          # src/test/java íŒŒì¼ ìˆ˜ì§‘
          if src_test.exists():
              for level_dir in sorted(src_test.iterdir()):
                  if level_dir.is_dir():
                      level = level_dir.name.upper()
                      for java_file in sorted(level_dir.glob('*Test.java')):
                          problem_name = java_file.stem.replace('Test', '')
                          key = f"{level}:{problem_name}"
                          problems[key]['test'] = str(java_file.relative_to(base_path))
                          if 'level' not in problems[key]:
                              problems[key]['level'] = level
                              problems[key]['name'] = problem_name
          
          # docs/problems/programmers íŒŒì¼ ìˆ˜ì§‘
          if docs_path.exists():
              for level_dir in sorted(docs_path.iterdir()):
                  if level_dir.is_dir():
                      level = level_dir.name.upper()
                      for md_file in sorted(level_dir.glob('*.md')):
                          problem_name = md_file.stem
                          key = f"{level}:{problem_name}"
                          problems[key]['doc'] = str(md_file.relative_to(base_path))
                          if 'level' not in problems[key]:
                              problems[key]['level'] = level
                              problems[key]['name'] = problem_name
          
          # Markdown ìƒì„±
          output_file.parent.mkdir(parents=True, exist_ok=True)
          
          with open(output_file, 'w', encoding='utf-8') as f:
              f.write('# Programmers ë¬¸ì œ ëª©ë¡\n\n')
              f.write('> ìžë™ ìƒì„±ëœ ë¬¸ì œ ëª©ë¡ìž…ë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ íŽ¸ì§‘í•˜ì§€ ë§ˆì„¸ìš”.\n\n')
              f.write('---\n\n')
              
              # ë ˆë²¨ë³„ë¡œ ê·¸ë£¹í™”
              levels = defaultdict(list)
              for key, data in problems.items():
                  level = data.get('level', 'UNKNOWN')
                  levels[level].append(data)
              
              # ë ˆë²¨ ìˆœì„œëŒ€ë¡œ ì •ë ¬
              level_order = ['LV0', 'LV1', 'LV2', 'LV3', 'LV4', 'LV5']
              
              for level in level_order:
                  if level not in levels:
                      continue
                  
                  f.write(f'## {level}\n\n')
                  f.write('| ë¬¸ì œëª… | í’€ì´ | í…ŒìŠ¤íŠ¸ | ë¬¸ì„œ |\n')
                  f.write('|--------|------|--------|------|\n')
                  
                  for data in sorted(levels[level], key=lambda x: x['name']):
                      name = data['name']
                      solution_link = f"[ðŸ“]({data['solution']})" if data['solution'] else '-'
                      test_link = f"[ðŸ§ª]({data['test']})" if data['test'] else '-'
                      doc_link = f"[ðŸ“–]({data['doc']})" if data['doc'] else '-'
                      
                      f.write(f'| {name} | {solution_link} | {test_link} | {doc_link} |\n')
                  
                  f.write('\n')
              
              # í†µê³„ ì¶”ê°€
              f.write('---\n\n')
              f.write('## ðŸ“Š í†µê³„\n\n')
              total_problems = len(problems)
              total_with_solution = sum(1 for p in problems.values() if p['solution'])
              total_with_test = sum(1 for p in problems.values() if p['test'])
              total_with_doc = sum(1 for p in problems.values() if p['doc'])
              
              f.write(f'- ì „ì²´ ë¬¸ì œ: {total_problems}ê°œ\n')
              f.write(f'- í’€ì´ ì™„ë£Œ: {total_with_solution}ê°œ\n')
              f.write(f'- í…ŒìŠ¤íŠ¸ ìž‘ì„±: {total_with_test}ê°œ\n')
              f.write(f'- ë¬¸ì„œí™” ì™„ë£Œ: {total_with_doc}ê°œ\n')
              
              if total_problems > 0:
                  completion_rate = (total_with_doc / total_problems) * 100
                  f.write(f'- ë¬¸ì„œí™”ìœ¨: {completion_rate:.1f}%\n')
          
          print(f"âœ… {output_file} ìƒì„± ì™„ë£Œ!")
          print(f"ðŸ“ ì´ {len(problems)}ê°œ ë¬¸ì œ ìˆ˜ì§‘")
          EOF
          
      - name: Check if there are changes
        id: check_changes
        run: |
          git diff --quiet problems/programmers.md || echo "changed=true" >> $GITHUB_OUTPUT
          
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add problems/programmers.md
          git commit -m "docs: auto-update programmers problem list"
          git push